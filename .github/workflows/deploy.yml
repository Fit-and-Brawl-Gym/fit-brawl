name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to AWS/Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'server-renderer/package-lock.json'

      - name: Install server-renderer dependencies
        run: |
          cd server-renderer
          npm ci --no-audit --no-fund

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            # Diagnostic information
            echo "ğŸ” Deployment Diagnostics:"
            echo "   User: $(whoami)"
            echo "   Home: $HOME"
            echo "   Current directory: $(pwd)"
            
            # Navigate to project directory
            echo ""
            echo "ğŸ“‚ Navigating to project directory..."
            cd /home/ec2-user/fit-brawl || {
              echo "âŒ ERROR: Cannot access /home/ec2-user/fit-brawl"
              exit 1
            }
            echo "âœ… Current directory: $(pwd)"
            
            # Check if it's a git repository
            echo ""
            echo "ğŸ” Checking git repository..."
            if [ ! -d .git ]; then
              echo "âŒ ERROR: Not a git repository!"
              exit 1
            fi
            echo "âœ… Git repository confirmed"
            echo "   Remote: $(git remote get-url origin)"

            # Pull latest changes from GitHub
            echo ""
            echo "ğŸ“¥ Pulling latest code..."
            if ! git fetch origin main 2>&1; then
              echo "âŒ ERROR: Git fetch failed!"
              echo "Attempting to continue anyway..."
            fi
            
            if ! git reset --hard origin/main 2>&1; then
              echo "âŒ ERROR: Git reset failed!"
              exit 1
            fi
            
            # Show current commit
            echo "âœ… Updated to commit: $(git rev-parse --short HEAD)"
            echo "ğŸ“ Last commit: $(git log -1 --pretty=format:%s)"

            # Install/update server-renderer dependencies
            echo ""
            echo "ğŸ“¦ Installing renderer dependencies..."
            cd server-renderer || {
              echo "âŒ ERROR: Cannot access server-renderer directory"
              exit 1
            }
            
            if npm ci --no-audit --no-fund 2>&1; then
              echo "âœ… Dependencies installed"
            else
              echo "âŒ ERROR: npm install failed!"
              exit 1
            fi

            # Restart renderer service
            echo ""
            echo "ğŸ”„ Restarting renderer service..."
            cd ..
            if systemctl is-active --quiet fit-brawl-renderer 2>/dev/null; then
              sudo systemctl restart fit-brawl-renderer
              echo "âœ… Renderer service restarted (systemd)"
            else
              # If no systemd service, restart manually
              echo "   Killing existing renderer processes..."
              pkill -f "node.*server.js" || true
              cd server-renderer
              nohup node server.js > /tmp/renderer.log 2>&1 &
              echo "âœ… Renderer restarted in background (PID: $!)"
              cd ..
            fi

            # Set proper permissions for uploads
            echo ""
            echo "ğŸ”’ Setting permissions..."
            if [ -d "uploads" ]; then
              sudo chown -R apache:apache uploads/ 2>/dev/null || sudo chown -R ec2-user:ec2-user uploads/
              sudo chmod -R 755 uploads/
              echo "âœ… Permissions updated"
            else
              echo "âš ï¸  Warning: uploads directory not found"
            fi

            # Final status
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Website: http://54.227.103.23"
            echo "ğŸ“¦ Commit: $(git rev-parse --short HEAD)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸš€ Deployment succeeded!"
          else
            echo "âŒ Deployment failed!"
          fi
