name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to AWS/Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'server-renderer/package-lock.json'

      - name: Install server-renderer dependencies
        run: |
          cd server-renderer
          npm ci --no-audit --no-fund

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # Navigate to project directory
            cd /home/ec2-user/fit-brawl || exit 1

            # Pull latest changes from GitHub
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Show current commit
            echo "âœ… Updated to commit: $(git rev-parse --short HEAD)"
            echo "ğŸ“ Last commit: $(git log -1 --pretty=%B)"

            # Install/update server-renderer dependencies
            echo "ğŸ“¦ Installing renderer dependencies..."
            cd server-renderer
            npm ci --no-audit --no-fund 2>&1 | tail -3

            # Restart renderer service
            echo "ğŸ”„ Restarting renderer service..."
            cd ..
            if systemctl is-active --quiet fit-brawl-renderer 2>/dev/null; then
              sudo systemctl restart fit-brawl-renderer
              echo "âœ… Renderer service restarted"
            else
              # If no systemd service, restart manually
              pkill -f "node.*server.js" || true
              cd server-renderer
              nohup node server.js > /tmp/renderer.log 2>&1 &
              echo "âœ… Renderer restarted in background (PID: $!)"
              cd ..
            fi

            # Set proper permissions for uploads
            echo "ğŸ”’ Setting permissions..."
            sudo chown -R apache:apache uploads/ 2>/dev/null || sudo chown -R ec2-user:ec2-user uploads/
            sudo chmod -R 755 uploads/

            # Run database migrations if any
            if [ -d "docs/database/migrations" ]; then
              echo "ğŸ—„ï¸ Checking for database migrations..."
              # Add migration logic here if needed
            fi

            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Website updated at: http://54.227.103.23"
            echo ""

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸš€ Deployment succeeded!"
          else
            echo "âŒ Deployment failed!"
          fi
